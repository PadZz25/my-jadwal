<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mahasiswa Ultimate - Fadly M.Z.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .chart-container { position: relative; width: 100%; max-width: 450px; margin: auto; height: 450px; max-height: 60vh; }
        @media (max-width: 768px) { .chart-container { height: 400px; } }
        .task-item:hover .task-actions { opacity: 1; transform: scale(1); }
        .task-actions { opacity: 0; transform: scale(0.8); transition: all 0.2s ease-in-out; }
        .gradient-text { background: linear-gradient(to right, #118AB2, #06D6A0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .dark .dark\:gradient-text { background: linear-gradient(to right, #67e8f9, #34d399); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .reveal.visible { opacity: 1; transform: translateY(0); }
        .card-hover { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .glassmorphism { background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glassmorphism { background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dragging { opacity: 0.5; }
        #quote-text::after { content: '|'; animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: #118AB2; } }
        .aurora-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(125deg, #06D6A0, #118AB2, #FFD166, #FF6B6B); background-size: 400% 400%; animation: aurora 15s ease infinite; }
        .dark .aurora-background { opacity: 0.3; }
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .link-preview { border-left: 4px solid #118AB2; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div class="aurora-background"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl relative z-10">

        <header class="text-center mb-10 relative">
            <h1 id="greeting" class="text-2xl md:text-3xl font-bold text-gray-700 dark:text-gray-300"></h1>
            <h2 class="text-4xl md:text-5xl font-black gradient-text dark:dark:gradient-text">Student Dashboard Ultimate</h2>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Kelas Internasional | S1 Teknik Informatika</p>
            <div class="absolute top-0 right-0 flex items-center gap-2">
                 <button id="profile-button" class="p-2 rounded-full bg-white/50 dark:bg-gray-800/50 focus:outline-none flex items-center justify-center w-10 h-10">
                    <img id="profile-avatar" src="" class="w-full h-full rounded-full object-cover hidden">
                    <span id="profile-initials" class="font-bold text-lg"></span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full bg-white/50 dark:bg-gray-800/50 focus:outline-none">
                    <svg id="theme-toggle-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-toggle-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
            <div class="absolute top-0 left-0">
                <button id="cmd-palette-button" class="p-2 rounded-lg bg-white/50 dark:bg-gray-800/50 text-xs font-mono text-gray-500 dark:text-gray-400">Ctrl+K</button>
            </div>
        </header>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div id="next-class" class="p-6 rounded-xl shadow-lg text-center glassmorphism">
                <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">KELAS BERIKUTNYA DALAM</h3>
                <div id="countdown-timer" class="text-5xl font-extrabold my-2 text-[#118AB2] dark:text-[#67e8f9]">--:--:--</div>
                <p id="next-class-info" class="font-bold text-xl text-gray-700 dark:text-gray-300">Memeriksa jadwal...</p>
            </div>
             <div id="quote-of-the-day" class="p-6 rounded-xl shadow-lg text-center glassmorphism flex flex-col justify-center">
                <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">KUTIPAN SEMANGAT HARI INI</h3>
                <p id="quote-text" class="font-bold text-xl text-gray-700 dark:text-gray-300 h-16 mt-2"></p>
            </div>
        </section>

        <section id="goal-tracker" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg mb-12 reveal">
            <h2 class="text-2xl md:text-3xl font-bold text-center">üèÜ Pelacak Tujuan Semester</h2>
            <div id="goal-list" class="mt-6 space-y-4"></div>
            <div class="mt-4 flex gap-4">
                <input type="text" id="goal-input" placeholder="Tujuan baru... (e.g., Baca 10 buku)" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                <input type="number" id="goal-total" placeholder="Target (e.g., 10)" class="w-24 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                <button id="add-goal-btn" class="bg-[#06D6A0] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-600">Tambah</button>
            </div>
        </section>

        <section id="resource-hub" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg mb-12 reveal">
             <h2 class="text-2xl md:text-3xl font-bold text-center">üìö Pusat Sumber Belajar</h2>
             <div id="resource-list" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
             <div class="mt-4 flex gap-4">
                <input type="text" id="resource-name-input" placeholder="Nama Link (e.g., E-Learning)" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                <input type="url" id="resource-url-input" placeholder="URL (e.g., https://...)" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700">
                <button id="add-resource-btn" class="bg-[#118AB2] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-cyan-700">Simpan</button>
            </div>
        </section>
        
        <section id="sks-distribution" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg mb-12 reveal"><h2 class="text-2xl md:text-3xl font-bold text-center">Komposisi Beban SKS</h2><p class="text-center text-gray-600 dark:text-gray-400 mb-6">Visualisasi porsi setiap mata kuliah dari total 20 SKS kamu.</p><div class="chart-container"><canvas id="sksChart"></canvas></div></section>
        <section id="weekly-schedule" class="mb-12 reveal"><h2 class="text-2xl md:text-3xl font-bold text-center mb-6">Jadwal Mingguan</h2><div id="schedule-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></div></section>

        <section id="task-manager" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg reveal">
            <h2 class="text-2xl md:text-3xl font-bold text-center">Manajemen Tugas Interaktif</h2>
            <form id="taskForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-8"><div class="md:col-span-2"><label for="taskInput" class="block text-sm font-medium mb-1">Tugas Baru / Link Materi</label><input type="text" id="taskInput" placeholder="Ketik tugas atau tempel link di sini..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700"></div><div><label for="courseSelect" class="block text-sm font-medium mb-1">Mata Kuliah</label><select id="courseSelect" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700"></select></div><div><label for="deadlineInput" class="block text-sm font-medium mb-1">Deadline</label><input type="date" id="deadlineInput" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-gray-50 dark:bg-gray-700"></div><button type="submit" class="w-full bg-[#06D6A0] text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition-colors">Tambah Tugas</button></form>
            <div id="taskList" class="space-y-4"></div>
        </section>

    </div>
    
    <!-- MODALS -->
    <div id="focus-modal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-md flex-col items-center justify-center z-50 hidden"><h2 id="focus-task-name" class="text-4xl font-bold text-white mb-4 text-center"></h2><div id="pomodoro-timer" class="text-9xl font-extrabold text-white">25:00</div><div class="mt-8 flex space-x-4"><button id="pomodoro-start" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg">Mulai</button><button id="pomodoro-pause" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg">Jeda</button><button id="pomodoro-close" class="bg-red-500 text-white font-bold py-3 px-6 rounded-lg">Keluar</button></div><p id="pomodoro-status" class="text-white text-xl mt-4">Waktunya Fokus!</p></div>
    
    <div id="profile-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
             <button id="profile-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
             <h2 class="text-2xl font-bold text-center mb-6">Profil & Statistik</h2>
             <div class="flex flex-col items-center gap-4 mb-6">
                 <img id="profile-modal-avatar" src="" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 dark:border-gray-700">
                 <div class="text-center">
                    <input id="profile-name-input" type="text" class="text-xl font-bold text-center bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-cyan-500 rounded-md">
                    <p class="text-gray-500">250535617974 - S1 TI Kelas Internasional</p>
                 </div>
             </div>
             <div class="space-y-4">
                <div><label class="block text-sm font-medium">Link Foto Profil</label><input id="profile-avatar-url-input" type="url" placeholder="https://..." class="w-full mt-1 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div>
                <div><label class="block text-sm font-medium">Target IPK Semester</label><input id="profile-gpa-input" type="number" step="0.01" max="4" min="0" placeholder="3.80" class="w-full mt-1 px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"></div>
             </div>
             <div class="grid grid-cols-2 gap-4 mt-6 text-center">
                 <div><p class="text-3xl font-bold" id="stats-tasks-completed">0</p><p class="text-sm text-gray-500">Tugas Selesai</p></div>
                 <div><p class="text-3xl font-bold" id="stats-productivity-streak">0 üî•</p><p class="text-sm text-gray-500">Productivity Streak</p></div>
             </div>
             <button id="profile-save-btn" class="w-full mt-6 bg-cyan-600 text-white font-bold py-2 rounded-lg hover:bg-cyan-700">Simpan Perubahan</button>
        </div>
    </div>

    <div id="cmd-palette-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-start justify-center pt-20 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg">
            <input id="cmd-input" type="text" placeholder="Ketik perintah..." class="w-full p-4 bg-transparent text-lg focus:outline-none">
            <div id="cmd-list" class="border-t border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto"></div>
        </div>
    </div>
    
    <footer class="text-center py-6 mt-10 bg-white/50 dark:bg-gray-800/50 backdrop-blur-sm"><p class="text-gray-600 dark:text-gray-400">Dibuat Khusus untuk Fadly | Semangat di Kelas Internasional!</p></footer>
    <audio id="task-complete-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_1b75c913a3.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, deleteDoc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KUNCI RAHASIA SUDAH TERPASANG ---
        const firebaseConfig = {
¬†           apiKey: "AIzaSyCsDdPcEKqzFd2RjMeNZ2StNt572jtf9ts",
¬†           authDomain: "dashboard-fadly.firebaseapp.com",
¬†           projectId: "dashboard-fadly",
¬†           storageBucket: "dashboard-fadly.firebasestorage.app",
¬†           messagingSenderId: "962523672113",
¬†           appId: "1:962523672113:web:37b6de93228e382f2eaf10",
¬†           measurementId: "G-8P7RTYTPKD"
        };
        // --- SINKRONISASI AKTIF ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let tasks = [], goals = [], profile = {}, resources = [];
        let unsubscribeTasks, unsubscribeGoals, unsubscribeProfile, unsubscribeResources;
        let taskCountdownInterval;

        document.addEventListener('DOMContentLoaded', () => {
            const courseList = ['Programming and Algorithm','Computer Architecture','Intro to IT','Computer Mathematics 1','Islamic Religion','English for Professional Purposes','Occupational Health and Safety','Lainnya'];
            initSKSChart(); initThemeToggler(); initDynamicGreeting(); initCountdownTimer(); initScrollReveal(); initTaskManager(courseList); initQuoteOfTheDay(); renderScheduleGrid(); initFocusMode(); initGoalTracker(); initProfile(); initResourceHub(); initCommandPalette();
            onAuthStateChanged(auth, (user) => { if (user) { setupRealtimeListeners(user.uid); } else { signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error)); } });
        });
        
        function setupRealtimeListeners(userId) {
            if(unsubscribeTasks) unsubscribeTasks(); if(unsubscribeGoals) unsubscribeGoals(); if(unsubscribeProfile) unsubscribeProfile(); if(unsubscribeResources) unsubscribeResources();
            const profileRef = doc(db, 'users', userId);
            unsubscribeProfile = onSnapshot(profileRef, (docSnap) => { profile = docSnap.exists() ? docSnap.data() : { name: "Fadly M.Z.", avatarUrl: "", gpaTarget: 3.8, stats: { completed: 0, streak: 0, lastCompletion: null } }; renderProfile(); renderProfileStats(); });
            const tasksRef = collection(db, 'users', userId, 'tasks');
            const tasksQuery = query(tasksRef, orderBy('order', 'asc'));
            unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => { tasks = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); renderTasks(); });
            const goalsRef = collection(db, 'users', userId, 'goals');
            unsubscribeGoals = onSnapshot(goalsRef, (snapshot) => { goals = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); renderGoals(); });
            const resourcesRef = collection(db, 'users', userId, 'resources');
            unsubscribeResources = onSnapshot(resourcesRef, (snapshot) => { resources = snapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id })); renderResources(); });
        }
        
        function initThemeToggler() {
            const themeToggle = document.getElementById('theme-toggle'), sunIcon = document.getElementById('theme-toggle-sun'), moonIcon = document.getElementById('theme-toggle-moon'), html = document.documentElement;
            const applyTheme = (theme) => { html.className = theme; sunIcon.classList.toggle('hidden', theme === 'dark'); moonIcon.classList.toggle('hidden', theme === 'light'); localStorage.setItem('theme', theme); if(window.sksChart && window.sksChart.options) { window.sksChart.options.plugins.legend.labels.color = theme === 'dark' ? '#FFF' : '#333'; window.sksChart.update(); } };
            themeToggle.addEventListener('click', () => applyTheme(html.classList.contains('dark') ? 'light' : 'dark'));
            applyTheme(localStorage.getItem('theme') || 'light');
        }
        function initDynamicGreeting() {
            const greetingEl = document.getElementById('greeting'), hour = new Date().getHours();
            if (hour < 11) greetingEl.textContent = 'Selamat Pagi!'; else if (hour < 15) greetingEl.textContent = 'Selamat Siang!'; else if (hour < 19) greetingEl.textContent = 'Selamat Sore!'; else greetingEl.textContent = 'Selamat Malam!';
        }
        function initCountdownTimer() {
            const schedule = [ { day: 1, start: "07:00", name: "Programming and Algorithm" }, { day: 1, start: "10:30", name: "English for Professional Purposes" }, { day: 2, start: "07:00", name: "Computer Architecture" }, { day: 2, start: "09:35", name: "Intro to IT" }, { day: 3, start: "09:35", name: "Computer Mathematics 1" }, { day: 3, start: "14:55", name: "Islamic Religion" }, { day: 5, start: "07:00", name: "Occupational Health and Safety" }, { day: 6, start: "07:00", name: "Islamic Religion" }, ];
            const findNextClass = () => { const now = new Date(); for (let i = 0; i < 7; i++) { const checkDay = (now.getDay() + i) % 7; const dayClasses = schedule.filter(c => c.day === checkDay).sort((a, b) => parseInt(a.start.replace(':', '')) - parseInt(b.start.replace(':', ''))); for (const cls of dayClasses) { const [h, m] = cls.start.split(':'); const classTime = new Date(now); classTime.setDate(now.getDate() + i); classTime.setHours(h, m, 0, 0); if (classTime > now) return { ...cls, date: classTime }; } } return null; };
            const updateCountdown = () => { const countdownTimerEl = document.getElementById('countdown-timer'), nextClassInfoEl = document.getElementById('next-class-info'), nextClass = findNextClass(); if (!nextClass) { countdownTimerEl.textContent = "HORE!"; nextClassInfoEl.textContent = "Tidak ada kelas lagi minggu ini!"; return; } const diff = nextClass.date - new Date(); if (diff <= 0) { setTimeout(updateCountdown, 1000); return; } const d = Math.floor(diff / (1000*60*60*24)), h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60)), m = Math.floor((diff % (1000*60*60)) / (1000*60)), s = Math.floor((diff % (1000*60)) / 1000); countdownTimerEl.textContent = d > 0 ? `${d} Hari ${h} Jam` : `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; const dayName = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'][nextClass.date.getDay()]; nextClassInfoEl.textContent = `${nextClass.name} - ${dayName}, ${nextClass.start}`; };
            setInterval(updateCountdown, 1000); updateCountdown();
        }
        function initQuoteOfTheDay() {
            const quoteTextEl = document.getElementById('quote-text');
            const quotes = [ "Satu-satunya cara untuk melakukan pekerjaan hebat adalah dengan mencintai apa yang kamu lakukan.", "Pendidikan adalah senjata paling ampuh yang bisa kamu gunakan untuk mengubah dunia.", "Jangan berhenti ketika lelah. Berhentilah ketika selesai.", "Mimpi tidak menjadi kenyataan melalui sihir; butuh keringat, tekad, dan kerja keras.", "Percayalah pada dirimu sendiri dan semua yang kamu miliki." ];
            const quote = quotes[Math.floor(Math.random() * quotes.length)]; let i = 0;
            const typeWriter = () => { if (i < quote.length) { quoteTextEl.innerHTML += quote.charAt(i); i++; setTimeout(typeWriter, 50); } };
            typeWriter();
        }
        function initScrollReveal() {
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('visible'); }); }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
        }
        function initTaskManager(courseList) {
            const taskForm = document.getElementById('taskForm'), taskInput = document.getElementById('taskInput'), courseSelect = document.getElementById('courseSelect'), deadlineInput = document.getElementById('deadlineInput'), taskListEl = document.getElementById('taskList');
            courseList.forEach(course => { const option = document.createElement('option'); option.textContent = course; courseSelect.appendChild(option); });
            taskInput.addEventListener('paste', async e => { const pastedText = (e.clipboardData || window.clipboardData).getData('text'); if (pastedText.startsWith('http')) { e.preventDefault(); await addTask(pastedText, true); } });
            taskForm.addEventListener('submit', async (e) => { e.preventDefault(); await addTask(taskInput.value.trim()); });
            const addTask = async (text, isUrl = false) => { if (!text || !auth.currentUser) return; const newTask = { text, course: courseSelect.value, deadline: deadlineInput.value, id: Date.now(), isUrl, order: tasks.length }; taskInput.value = ''; deadlineInput.value = ''; const docRef = await addDoc(collection(db, 'users', auth.currentUser.uid, 'tasks'), newTask); if (isUrl) await fetchLinkPreview(docRef.id, text); };
            taskListEl.addEventListener('dragover', e => { e.preventDefault(); const draggable = document.querySelector('.dragging'); if (!draggable) return; const afterElement = getDragAfterElement(taskListEl, e.clientY); if (afterElement == null) taskListEl.appendChild(draggable); else taskListEl.insertBefore(draggable, afterElement); });
            taskListEl.addEventListener('drop', async () => { const newOrderedIds = Array.from(taskListEl.querySelectorAll('.task-item')).map(item => item.dataset.firestoreId); for(let i=0; i < newOrderedIds.length; i++){ const taskRef = doc(db, 'users', auth.currentUser.uid, 'tasks', newOrderedIds[i]); await updateDoc(taskRef, { order: i }); } });
            taskListEl.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const itemToRemove = e.target.closest('.task-item'); const firestoreId = itemToRemove.dataset.firestoreId;
                    await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'tasks', firestoreId));
                    await updateStatsOnTaskComplete();
                    itemToRemove.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; itemToRemove.style.opacity = '0'; itemToRemove.style.transform = 'translateX(100px)';
                    document.getElementById('task-complete-sound').play(); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
                if (e.target.closest('.focus-btn')) { const id = e.target.closest('.task-item').dataset.id; const task = tasks.find(t => t.id == id); startFocusMode(task.text); }
            });
            startTaskCountdown();
        }
        async function updateStatsOnTaskComplete() {
            if (!auth.currentUser) return;
            const statsRef = doc(db, 'users', auth.currentUser.uid);
            const today = new Date().toISOString().slice(0, 10);
            let currentStats = profile.stats || { completed: 0, streak: 0, lastCompletion: null };
            currentStats.completed++;
            if (currentStats.lastCompletion !== today) { const lastDate = currentStats.lastCompletion ? new Date(currentStats.lastCompletion) : new Date(0); const todayDate = new Date(today); const diffDays = (todayDate - lastDate) / (1000 * 60 * 60 * 24); currentStats.streak = diffDays === 1 ? (currentStats.streak || 0) + 1 : 1; }
            currentStats.lastCompletion = today;
            await setDoc(statsRef, { stats: currentStats }, { merge: true });
        }
        async function fetchLinkPreview(firestoreId, url) {
            try {
                const response = await fetch(`https://jsonlink.io/api/extract?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const taskRef = doc(db, 'users', auth.currentUser.uid, 'tasks', firestoreId);
                await updateDoc(taskRef, { preview: { title: data.title || "No Title", description: data.description || "", image: data.images[0] || "" } });
            } catch (error) { console.error('Link preview error:', error); }
        }
        function renderTasks() {
            const taskListEl = document.getElementById('taskList'); taskListEl.innerHTML = '';
            if (tasks.length === 0) { taskListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">Hore, tidak ada tugas!</p>`; return; }
            tasks.forEach((task) => {
                const item = document.createElement('div');
                item.className = 'task-item bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg shadow-sm';
                item.setAttribute('draggable', true); item.dataset.id = task.id; item.dataset.firestoreId = task.firestoreId;
                item.addEventListener('dragstart', () => item.classList.add('dragging')); item.addEventListener('dragend', () => item.classList.remove('dragging'));
                const deadline = task.deadline ? new Date(task.deadline) : null; const totalDuration = deadline ? (deadline - new Date(task.id)) : 0; const remainingTime = deadline ? (deadline - new Date()) : -1;
                let progressColor = 'bg-gray-400';
                if(deadline) { const timeRemainingRatio = remainingTime / totalDuration; if (timeRemainingRatio > 0.5) progressColor = 'bg-green-500'; else if (timeRemainingRatio > 0.2) progressColor = 'bg-yellow-500'; else progressColor = 'bg-red-500'; }
                let previewHtml = '';
                if (task.isUrl) { if (task.preview) { previewHtml = `<a href="${task.text}" target="_blank" class="link-preview mt-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg flex gap-4 items-center card-hover"><img src="${task.preview.image}" onerror="this.style.display='none'" class="w-20 h-20 object-cover rounded-md"><div class="flex-1"><h4 class="font-bold">${task.preview.title}</h4><p class="text-xs text-gray-500 dark:text-gray-400">${(task.preview.description || "").substring(0, 100)}...</p></div></a>`; } else { previewHtml = `<div class="mt-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm">Memuat pratinjau...</div>`; } }
                item.innerHTML = `<div class="flex items-start justify-between"><div><p class="font-semibold">${task.isUrl ? (task.preview?.title || task.text) : task.text}</p><span class="text-xs font-bold px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-600">${task.course}</span></div><div class="task-actions flex items-center space-x-2"><button class="focus-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Mode Fokus"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></button><button class="delete-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Selesai"><svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></div></div>${previewHtml}${deadline ? `<div class="mt-3"><div class="flex justify-between text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1"><span>Deadline</span><span id="countdown-${task.id}">Menghitung...</span></div><div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5"><div class="${progressColor}" style="height:100%; width: ${100 - Math.max(0, Math.min(100, (remainingTime / totalDuration) * 100))}%; border-radius: inherit;"></div></div></div>` : ''}`;
                taskListEl.appendChild(item);
            });
        }
        function startTaskCountdown() {
            if (taskCountdownInterval) clearInterval(taskCountdownInterval);
            taskCountdownInterval = setInterval(() => {
                tasks.forEach(task => {
                    if (task.deadline) {
                        const countdownEl = document.getElementById(`countdown-${task.id}`);
                        if (countdownEl) { const diff = new Date(task.deadline) - new Date(); if (diff > 0) { const d = Math.floor(diff / (1000*60*60*24)), h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60)), m = Math.floor((diff % (1000*60*60)) / (1000*60)); countdownEl.textContent = `${d}h ${h}j ${m}m lagi`; } else { countdownEl.textContent = 'DEADLINE LEWAT!'; countdownEl.classList.add('text-red-500', 'font-bold'); } }
                    }
                });
            }, 60000);
        }
        function getDragAfterElement(container, y) { const draggableElements = [...container.querySelectorAll('.task-item:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
        function initFocusMode() {
            const modal = document.getElementById('focus-modal'), taskNameEl = document.getElementById('focus-task-name'), timerEl = document.getElementById('pomodoro-timer'), statusEl = document.getElementById('pomodoro-status'), startBtn = document.getElementById('pomodoro-start'), pauseBtn = document.getElementById('pomodoro-pause'), closeBtn = document.getElementById('pomodoro-close');
            let timerInterval, totalSeconds = 25 * 60, isPaused = true, isWorkSession = true;
            const updateTimerDisplay = () => { const minutes = Math.floor(totalSeconds / 60), seconds = totalSeconds % 60; timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
            const startTimer = () => { if(isPaused) { isPaused = false; timerInterval = setInterval(() => { totalSeconds--; updateTimerDisplay(); if (totalSeconds <= 0) { clearInterval(timerInterval); isWorkSession = !isWorkSession; totalSeconds = isWorkSession ? 25 * 60 : 5 * 60; statusEl.textContent = isWorkSession ? 'Waktunya Fokus!' : 'Waktunya Istirahat!'; updateTimerDisplay(); alert(isWorkSession ? "Istirahat selesai!" : "Sesi fokus selesai!"); isPaused = true; } }, 1000); } };
            const pauseTimer = () => { isPaused = true; clearInterval(timerInterval); }; const closeFocusMode = () => { pauseTimer(); modal.classList.add('hidden'); };
            window.startFocusMode = (taskName) => { taskNameEl.textContent = taskName; totalSeconds = 25 * 60; isWorkSession = true; isPaused = true; statusEl.textContent = 'Waktunya Fokus!'; updateTimerDisplay(); modal.classList.remove('hidden'); modal.classList.add('flex'); };
            startBtn.addEventListener('click', startTimer); pauseBtn.addEventListener('click', pauseTimer); closeBtn.addEventListener('click', closeFocusMode);
        }
        function renderScheduleGrid() {
            const gridEl = document.getElementById('schedule-grid'); gridEl.innerHTML = ''; const days = ['SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU', 'MINGGU'];
            const scheduleData = { SENIN: [ { time: '07.00 - 10.25', jam: '1-4', title: 'Programming and Algorithm', lecturer: 'Muhammad Jauharul Fuady', room: 'B11-414', color: 'border-red-500' }, { time: '10.30 - 12.10', jam: '5-6', title: 'English for Professional Purposes', lecturer: 'Muhammad Iqbal Akbar', room: 'A20-211', color: 'border-yellow-500' } ], SELASA: [ { time: '07.00 - 09.35', jam: '1-3', title: 'Organization and Computer Architecture', lecturer: 'Muhammad Ashar', room: 'B12-205', color: 'border-green-500' }, { time: '09.35 - 12.10', jam: '4-6', title: 'Introduction to Information Technology', lecturer: 'Heni Vidia Sari', room: 'A19-405', color: 'border-blue-500' } ], RABU: [ { time: '09.35 - 12.10', jam: '4-6', title: 'Computer Mathematics 1', lecturer: 'Muhammad Iqbal Akbar', room: 'A20-208', color: 'border-blue-500' }, { break: true, time: '12.10 - 14.55' }, { time: '14.55 - 16.35', jam: '9-10', title: 'Islamic Religion Education', lecturer: 'Muhammad Alfan', room: 'A19-710', color: 'border-indigo-500' } ], KAMIS: [], JUMAT: [{ time: '07.00 - 08.40', jam: '1-2', title: 'Occupational Health and Safety', lecturer: 'Muis Muhtadi', room: 'B12-113', color: 'border-pink-500' }], SABTU: [{ time: '07.00 - 10.25', jam: '1-4', title: 'Islamic Religion Education', lecturer: 'Muhammad Alfan', room: 'F2.1', color: 'border-indigo-500' }], MINGGU: [] };
            days.forEach(day => { const dayClasses = scheduleData[day]; let content = ''; if(dayClasses.length === 0) { const icon = day === 'KAMIS' ? 'üò¥' : 'üéâ'; content = `<div class="bg-gray-200 dark:bg-gray-800/50 border-t-4 border-gray-400 rounded-lg shadow-md p-6 flex flex-col items-center justify-center h-full mt-6 card-hover"><div class="text-6xl mb-4">${icon}</div><h4 class="font-bold text-2xl">${day === 'MINGGU' ? 'Akhir Pekan!' : 'Hari Kosong'}</h4></div>`; } else { dayClasses.forEach(c => { if (c.break) { content += `<div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-lg shadow-md border-t-4 border-green-500 text-center card-hover"><p class="font-bold text-gray-500 dark:text-gray-400 text-sm">${c.time}</p><h4 class="font-bold text-lg text-green-800 dark:text-green-300">‚òï JEDA PANJANG ‚òï</h4></div>`; } else { content += `<div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-t-4 ${c.color} card-hover"><p class="font-bold text-gray-500 dark:text-gray-400 text-sm">${c.time}</p><p class="font-semibold text-gray-500 dark:text-gray-400 text-xs mt-1">üïí Jam ke-${c.jam}</p><h4 class="font-bold text-lg mt-2">${c.title}</h4><p class="text-gray-600 dark:text-gray-300 text-sm">${c.lecturer}</p><p class="font-semibold mt-2 text-sm">üìç ${c.room}</p></div>`; } }); } gridEl.innerHTML += `<div class="flex flex-col space-y-6"><h3 class="text-2xl font-bold text-center ${dayClasses.length === 0 ? 'bg-gray-600' : 'bg-[#073B4C] dark:bg-gray-700'} text-white py-2 rounded-lg shadow-md">${day}</h3>${content}</div>`; });
        }
        function initGoalTracker() {
            const goalListEl = document.getElementById('goal-list'), goalInput = document.getElementById('goal-input'), goalTotalInput = document.getElementById('goal-total'), addGoalBtn = document.getElementById('add-goal-btn');
            window.renderGoals = () => {
                goalListEl.innerHTML = '';
                if(goals.length === 0) { goalListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">Kamu belum punya tujuan semester ini.</p>`; return; }
                goals.forEach((goal) => {
                    const progress = (goal.current / goal.total) * 100;
                    const item = document.createElement('div');
                    item.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-bold">${goal.name}</span><span class="text-sm font-semibold">${goal.current} / ${goal.total}</span></div><div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4 relative"><div class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full" style="width: ${progress}%"></div><div class="absolute inset-0 flex justify-center items-center text-xs font-bold text-white">${Math.round(progress)}%</div></div><div class="flex justify-end gap-2 mt-2"><button data-id="${goal.firestoreId}" class="goal-decrement-btn bg-red-500 text-white w-8 h-8 rounded-full font-bold">-</button><button data-id="${goal.firestoreId}" class="goal-increment-btn bg-green-500 text-white w-8 h-8 rounded-full font-bold">+</button></div>`;
                    goalListEl.appendChild(item);
                });
            };
            addGoalBtn.addEventListener('click', async () => { const name = goalInput.value.trim(), total = parseInt(goalTotalInput.value); if (name && total > 0 && auth.currentUser) { await addDoc(collection(db, 'users', auth.currentUser.uid, 'goals'), { name, total, current: 0 }); goalInput.value = ''; goalTotalInput.value = ''; } });
            goalListEl.addEventListener('click', async e => { 
                const id = e.target.dataset.id; if(!id) return;
                const goal = goals.find(g => g.firestoreId === id); if(!goal) return;
                let shouldUpdate = false;
                if(e.target.classList.contains('goal-increment-btn')) { if(goal.current < goal.total) { goal.current++; shouldUpdate = true; } } 
                if(e.target.classList.contains('goal-decrement-btn')) { if(goal.current > 0) { goal.current--; shouldUpdate = true; } } 
                if (shouldUpdate) { const goalRef = doc(db, 'users', auth.currentUser.uid, 'goals', id); await updateDoc(goalRef, { current: goal.current }); } 
            });
        }
        function initProfile() {
            const profileButton = document.getElementById('profile-button'), profileModal = document.getElementById('profile-modal'), closeBtn = document.getElementById('profile-close-btn'), saveBtn = document.getElementById('profile-save-btn');
            const avatar = document.getElementById('profile-avatar'), initials = document.getElementById('profile-initials'), modalAvatar = document.getElementById('profile-modal-avatar');
            const nameInput = document.getElementById('profile-name-input'), avatarUrlInput = document.getElementById('profile-avatar-url-input'), gpaInput = document.getElementById('profile-gpa-input');
            window.renderProfile = () => {
                const name = profile.name || "Fadly M.Z.";
                nameInput.value = name;
                avatarUrlInput.value = profile.avatarUrl;
                gpaInput.value = profile.gpaTarget;
                if (profile.avatarUrl) {
                    avatar.src = profile.avatarUrl; modalAvatar.src = profile.avatarUrl;
                    avatar.classList.remove('hidden'); modalAvatar.classList.remove('hidden'); initials.classList.add('hidden');
                } else {
                    avatar.classList.add('hidden'); modalAvatar.classList.add('hidden'); initials.classList.remove('hidden');
                    initials.textContent = name.split(" ").map(n => n[0]).join("").substring(0,2).toUpperCase();
                }
            };
            profileButton.addEventListener('click', () => { profileModal.classList.remove('hidden'); profileModal.classList.add('flex'); });
            closeBtn.addEventListener('click', () => { profileModal.classList.add('hidden'); profileModal.classList.remove('flex'); });
            saveBtn.addEventListener('click', async () => {
                if (auth.currentUser) {
                    await setDoc(doc(db, 'users', auth.currentUser.uid), { 
                        name: nameInput.value, 
                        avatarUrl: avatarUrlInput.value, 
                        gpaTarget: gpaInput.value 
                    }, { merge: true });
                }
                profileModal.classList.add('hidden'); profileModal.classList.remove('flex');
            });
        }
        function renderProfileStats() {
             const stats = profile.stats || { completed: 0, streak: 0 };
             document.getElementById('stats-tasks-completed').textContent = stats.completed;
             document.getElementById('stats-productivity-streak').textContent = `${stats.streak} üî•`;
        }
        function initResourceHub() {
            const resourceListEl = document.getElementById('resource-list'), nameInput = document.getElementById('resource-name-input'), urlInput = document.getElementById('resource-url-input'), addBtn = document.getElementById('add-resource-btn');
            window.renderResources = () => {
                resourceListEl.innerHTML = '';
                if(resources.length === 0) { resourceListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">Belum ada link tersimpan.</p>`; return; }
                resources.forEach((res) => {
                    const item = document.createElement('a');
                    item.href = res.url; item.target = "_blank";
                    item.className = "bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg shadow-sm card-hover flex items-center gap-4 relative group";
                    const favicon = `https://www.google.com/s2/favicons?domain=${res.url}&sz=64`;
                    item.innerHTML = `<img src="${favicon}" class="w-8 h-8 rounded-md"><span class="font-semibold">${res.name}</span><button data-id="${res.firestoreId}" class="resource-delete-btn absolute top-2 right-2 p-1 rounded-full bg-red-500/80 text-white opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>`;
                    resourceListEl.appendChild(item);
                });
            };
            addBtn.addEventListener('click', async () => { const name = nameInput.value.trim(), url = urlInput.value.trim(); if(name && url && auth.currentUser) { await addDoc(collection(db, 'users', auth.currentUser.uid, 'resources'), {name, url}); nameInput.value = ''; urlInput.value = ''; } });
            resourceListEl.addEventListener('click', async e => { if(e.target.classList.contains('resource-delete-btn')) { e.preventDefault(); const id = e.target.dataset.id; await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'resources', id)); } });
        }
        function initCommandPalette() {
            const modal = document.getElementById('cmd-palette-modal'), input = document.getElementById('cmd-input'), list = document.getElementById('cmd-list'), btn = document.getElementById('cmd-palette-button');
            const commands = [
                { name: 'Tambah Tugas Baru', action: () => { document.getElementById('taskInput').focus(); } },
                { name: 'Ganti Tema', action: () => { document.getElementById('theme-toggle').click(); } },
                { name: 'Buka Profil', action: () => { document.getElementById('profile-button').click(); } },
                { name: 'Buka Pelacak Tujuan', action: () => { document.getElementById('goal-tracker').scrollIntoView(); } },
                { name: 'Buka Sumber Belajar', action: () => { document.getElementById('resource-hub').scrollIntoView(); } },
            ];
            const renderCommands = (filter = '') => { list.innerHTML = ''; commands.filter(cmd => cmd.name.toLowerCase().includes(filter.toLowerCase())).forEach(cmd => { const item = document.createElement('div'); item.className = "p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"; item.textContent = cmd.name; item.onclick = () => { cmd.action(); closeModal(); }; list.appendChild(item); }); };
            const openModal = () => { modal.classList.remove('hidden'); modal.classList.add('flex'); input.focus(); renderCommands(); };
            const closeModal = () => { modal.classList.add('hidden'); modal.classList.remove('flex'); input.value = ''; };
            btn.addEventListener('click', openModal);
            window.addEventListener('keydown', e => { if((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openModal(); } if(e.key === 'Escape') closeModal(); });
            input.addEventListener('input', () => renderCommands(input.value));
            modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        }
        function initSKSChart() {
            const data = { labels: ['Programming and Algorithm (4)','Computer Architecture (3)','Intro to IT (3)','Computer Mathematics 1 (3)','Islamic Religion (3)','English (2)','Health and Safety (2)'], datasets: [{ label: 'SKS', data: [4, 3, 3, 3, 3, 2, 2], backgroundColor: ['#FF6B6B','#FFD166','#06D6A0','#118AB2','#073B4C','#EE9B00','#9B2226'], borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' :'#FFFFFF', borderWidth: 3, hoverOffset: 15 }] };
            const config = { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { size: 12, weight: '600'}, padding: 15, usePointStyle: true, pointStyle: 'rectRounded' }}, tooltip: { enabled: true, backgroundColor: '#073B4C', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, callbacks: { title: (ctx) => ctx[0].label } } } } };
            window.sksChart = new Chart(document.getElementById('sksChart'), config);
        }
    </script>
</body>
</html>

